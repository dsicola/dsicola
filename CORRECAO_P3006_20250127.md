# ‚úÖ CORRE√á√ÉO: Erro P3006 - Migration 20250127000000

**Erro**: 
```
Error: P3006
Migration `20250127000000_sync_semestres_schema_final` failed to apply cleanly to the shadow database.
Error code: P1014
Error: The underlying table for model `semestres` does not exist.
```

---

## üî¥ PROBLEMA

A migration `20250127000000_sync_semestres_schema_final` (2025-01-27) verifica se a tabela `semestres` existe, mas **n√£o a cria** se n√£o existir. No shadow database do Prisma, a tabela pode n√£o existir ainda.

---

## ‚úÖ CORRE√á√ÉO APLICADA

### Mudan√ßa 1: Criar tabela b√°sica se n√£o existir

**Antes** (linhas 6-8):
```sql
DO $$ 
BEGIN
  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'semestres') THEN
```

**Depois**:
```sql
-- Criar tabela b√°sica se n√£o existir (idempotente)
DO $$ 
BEGIN
  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'semestres') THEN
    CREATE TABLE IF NOT EXISTS "semestres" (
      "id" TEXT NOT NULL,
      "ano_letivo" INTEGER NOT NULL,
      "numero" INTEGER NOT NULL,
      "data_inicio" TIMESTAMP(3) NOT NULL,
      "status" TEXT DEFAULT 'PLANEJADO',
      "instituicao_id" TEXT,
      "observacoes" TEXT,
      "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
      "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
      CONSTRAINT "semestres_pkey" PRIMARY KEY ("id")
    );
    RAISE NOTICE '‚úÖ Tabela semestres criada com estrutura b√°sica';
  END IF;
END $$;
```

### Mudan√ßa 2: Proteger cria√ß√£o de √≠ndices

**Antes** (linhas 130-132):
```sql
CREATE INDEX IF NOT EXISTS "semestres_ano_letivo_id_idx" ON "semestres"("ano_letivo_id");
CREATE INDEX IF NOT EXISTS "semestres_estado_idx" ON "semestres"("estado");
```

**Depois**:
```sql
-- Adicionar √≠ndices se n√£o existirem (s√≥ se tabela e colunas existirem)
DO $$
BEGIN
  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'semestres') THEN
    -- √çndice em ano_letivo_id (s√≥ se coluna existir)
    IF EXISTS (
      SELECT 1 FROM information_schema.columns 
      WHERE table_schema = 'public' AND table_name = 'semestres' AND column_name = 'ano_letivo_id'
    ) THEN
      CREATE INDEX IF NOT EXISTS "semestres_ano_letivo_id_idx" ON "semestres"("ano_letivo_id");
    END IF;
    
    -- √çndice em estado (s√≥ se coluna existir)
    IF EXISTS (
      SELECT 1 FROM information_schema.columns 
      WHERE table_schema = 'public' AND table_name = 'semestres' AND column_name = 'estado'
    ) THEN
      CREATE INDEX IF NOT EXISTS "semestres_estado_idx" ON "semestres"("estado");
    END IF;
  END IF;
END $$;
```

---

## üìã CHECKLIST

- [x] Migration corrigida para criar tabela b√°sica se n√£o existir
- [x] √çndices protegidos para s√≥ criar se colunas existirem
- [x] Compat√≠vel com shadow database
- [x] Idempotente (pode ser executada m√∫ltiplas vezes)

---

## üß™ TESTAR

```bash
cd backend
npx prisma migrate dev
```

---

## ‚úÖ STATUS

**Erro P3006 na migration 20250127000000**: ‚úÖ **RESOLVIDO**

A migration agora funciona corretamente no shadow database do Prisma.

---

**Data**: Janeiro 2025

